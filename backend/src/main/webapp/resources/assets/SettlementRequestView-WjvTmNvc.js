import{_ as I,r as _,s as T,q as C,o as D,c as w,e as a,f as n,g as e,x as E,j as F,t as r,h as R,y as L,F as y,p as g}from"./index-8PyfHxE5.js";import{H as M}from"./Header-ke2wFRbj.js";import{a as $,g as H,c as P,r as U}from"./settlementApi-D8sD_gkX.js";const j={class:"view-wrapper"},x={class:"settlement-view"},z={key:0,class:"content-container loading"},G={key:1,class:"content-container error"},J={key:2,class:"content-container"},K={class:"summary-header"},O={class:"trip-name"},Q={class:"total-amount"},W={class:"settlement-card"},X={class:"card-header"},Y=["value"],Z={class:"transaction-list"},ee={key:0},te={class:"member-info"},se={class:"avatar bg-theme-secondary"},ae={class:"amount"},ne={key:1,class:"empty-message"},oe={class:"settlement-card"},re={class:"card-header"},le=["value"],ie={class:"transaction-list"},ce={key:0},me={class:"member-info"},ue={class:"avatar bg-theme-primary"},de={class:"amount"},ve={key:1,class:"empty-message"},pe={__name:"SettlementRequestView",setup(_e){const o=_(null),N=_(!0),u=_(null),c=_(null),S=_(!1),V=T(),k=C(),d=V.params.tripId,q=()=>{k.push(`/settlement/${d}`)};D(async()=>{const m=new Promise(s=>setTimeout(s,700));try{const[s,t]=await Promise.all([$(d),H(d),m]),i=s.data||[],f=t.data;if(i.length>0){console.log("✅ 이미 정산이 생성됨. 기존 정산 표시:",i.length,"건"),S.value=!0;const l=new Set;i.forEach(h=>{h.senderNickname&&l.add(h.senderNickname),h.receiverNickname&&l.add(h.receiverNickname)}),o.value={settlements:i,members:Array.from(l),tripName:f.tripName,totalAmount:f.totalAmount,transactions:i},Array.from(l).length>0&&(c.value=Array.from(l)[0]);return}console.log("🔍 정산이 아직 생성되지 않음. 미리보기 계산 중...");const v=(await P(d)).data?.transactions||[];if(!Array.isArray(v)){console.error("transactions is not an array:",v),u.value="정산 데이터 형식이 올바르지 않습니다.";return}if(v.length===0){u.value="정산할 내역이 없습니다. 모든 멤버의 지출이 동일합니다.";return}const p=new Set;v.forEach(l=>{l.senderNickname&&p.add(l.senderNickname),l.receiverNickname&&p.add(l.receiverNickname)}),o.value={settlements:v,members:Array.from(p),tripName:f.tripName,totalAmount:f.totalAmount,transactions:v},Array.from(p).length>0&&(c.value=Array.from(p)[0])}catch(s){console.error("정산 정보 로딩 실패:",s),console.error("에러 상세:",s.response?.data),s.response?.status===403?u.value="그룹장만 정산을 조회할 수 있습니다.":s.response?.status===400?u.value=s.response.data?.message||"정산 계산에 실패했습니다.":u.value="데이터를 불러오는 데 실패했습니다."}finally{N.value=!1}});const b=w(()=>o.value?.settlements?o.value.settlements.filter(m=>m.receiverNickname===c.value):[]),A=w(()=>o.value?.settlements?o.value.settlements.filter(m=>m.senderNickname===c.value):[]),B=async()=>{if(S.value){k.push(`/settlement/${d}/detail`);return}if(confirm("모든 멤버에게 정산 요청을 보낼까요?"))try{await U({tripId:d}),alert("정산 요청을 성공적으로 보냈습니다!"),k.push(`/settlement/${d}/detail`)}catch(m){console.error("정산 요청 실패:",m),alert("정산 요청에 실패했습니다.")}};return(m,s)=>(n(),a("div",j,[e("div",x,[E(M,{title:"정산하기","back-action":q}),N.value?(n(),a("main",z,s[2]||(s[2]=[e("p",null,"최종 정산 결과를 계산하는 중...",-1)]))):u.value?(n(),a("main",G,[e("p",null,r(u.value),1)])):o.value?(n(),a("main",J,[e("div",K,[e("p",O,r(o.value.tripName),1),e("h2",Q," 총 "+r(o.value.totalAmount?.toLocaleString()||0)+"원 사용 ",1)]),e("div",W,[e("div",X,[R(e("select",{"onUpdate:modelValue":s[0]||(s[0]=t=>c.value=t),class:"member-select"},[(n(!0),a(y,null,g(o.value.members,t=>(n(),a("option",{key:t,value:t},r(t),9,Y))),128))],512),[[L,c.value]]),s[3]||(s[3]=e("span",{class:"card-title"},"님이 받을 돈",-1))]),e("div",Z,[b.value.length>0?(n(),a("div",ee,[(n(!0),a(y,null,g(b.value,(t,i)=>(n(),a("div",{key:i,class:"transaction-item"},[e("div",te,[e("div",se,[e("span",null,r(t.senderNickname.substring(0,1)),1)]),e("span",null,r(t.senderNickname),1)]),e("span",ae,r(t.amount.toLocaleString())+"원",1)]))),128))])):(n(),a("p",ne,"받을 돈이 없습니다."))])]),e("div",oe,[e("div",re,[R(e("select",{"onUpdate:modelValue":s[1]||(s[1]=t=>c.value=t),class:"member-select"},[(n(!0),a(y,null,g(o.value.members,t=>(n(),a("option",{key:t,value:t},r(t),9,le))),128))],512),[[L,c.value]]),s[4]||(s[4]=e("span",{class:"card-title"},"님이 보낼 돈",-1))]),e("div",ie,[A.value.length>0?(n(),a("div",ce,[(n(!0),a(y,null,g(A.value,(t,i)=>(n(),a("div",{key:i,class:"transaction-item"},[e("div",me,[e("div",ue,[e("span",null,r(t.receiverNickname.substring(0,1)),1)]),e("span",null,r(t.receiverNickname),1)]),e("span",de,r(t.amount.toLocaleString())+"원",1)]))),128))])):(n(),a("p",ve,"보낼 돈이 없습니다."))])])])):F("",!0),e("footer",{class:"footer"},[e("button",{onClick:B,class:"next-button"}," 정산 요청 보내기 ")])])]))}},ke=I(pe,[["__scopeId","data-v-5f37de1a"]]);export{ke as default};
