<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.scoula.report.mapper.OpenAiMapper">

    <!-- VO 필드 매핑 -->
    <resultMap id="OpenAiResultMap" type="org.scoula.report.domain.OpenAiVO">
        <result property="category"    column="category" />
        <result property="total_amount" column="total_amount" />
        <result property="date"        column="date" />
    </resultMap>

    <!-- 도넛 차트: 카테고리별 합계 -->
    <select id="selectDonutReport"
            parameterType="int"
            resultMap="OpenAiResultMap">
        SELECT
            COALESCE(mc.category_name, '기타') AS category,
            SUM(p.amount) AS total_amount
        FROM payment p
                 LEFT JOIN merchant m ON p.merchant_id = m.merchant_id
                 LEFT JOIN merchant_category mc ON m.category_id = mc.category_id
        WHERE p.trip_id = #{tripId}
        GROUP BY COALESCE(mc.category_name, '기타');
    </select>

    <!-- 라인 차트: 날짜별 건수 및 합계 -->
    <select id="selectLineReport"
            parameterType="int"
            resultMap="OpenAiResultMap">
        SELECT
            DATE(p.pay_at) AS date,
            SUM(p.amount) AS total_amount
        FROM payment p
        WHERE p.trip_id = #{tripId}
        GROUP BY DATE(p.pay_at)
        ORDER BY total_amount DESC
    </select>
</mapper>