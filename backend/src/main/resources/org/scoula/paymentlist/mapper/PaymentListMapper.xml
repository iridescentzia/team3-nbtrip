<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.scoula.paymentlist.mapper.PaymentListMapper">

    <!-- VO 필드 매핑 -->
    <resultMap id="PaymentListResultMap" type="org.scoula.paymentlist.domain.PaymentListVO">
        <id property="paymentId" column="paymentId"/>
        <result property="merchantId" column="merchantId"/>
        <result property="merchantName" column="merchantName"/>
        <result property="categoryId" column="categoryId"/>
        <result property="categoryName" column="categoryName"/>
        <result property="userId" column="userId"/>
        <result property="nickname" column="nickname"/>
        <result property="payAt" column="payAt"/>
        <result property="amount" column="amount"/>
        <result property="paymentType" column="paymentType"/>
        <result property="memo" column="memo"/>

        <!--    결제 참여자 리스트    -->
        <collection property="participants" ofType="org.scoula.payment.dto.ParticipantDTO">
            <result property="userId" column="participantUserId"></result>
            <result property="splitAmount" column="splitAmount"></result>
            <result property="paymentId" column="paymentId"></result>
        </collection>
    </resultMap>

    <!-- 결제 내역 불러오기: 사용자가 해당 trip에 속한 경우에만 -->
    <select id="selectPaymentList"
            parameterType="int"
            resultMap="PaymentListResultMap">
        SELECT
            p.payment_id AS paymentId,
            m.merchant_id AS merchantId,
            m.merchant_name AS merchantName,
            mc.category_id AS categoryId,
            mc.category_name AS categoryName,
            u.user_id AS userId,
            u.nickname AS nickname,
            p.pay_at AS payAt,
            p.amount,
            p.payment_type AS paymentType,
            p.memo,

            pp.user_id AS participantUserId,
            pp.split_amount AS splitAmount

        FROM payment p
                JOIN users u ON p.user_id = u.user_id
                JOIN merchant m ON p.merchant_id = m.merchant_id
                JOIN merchant_category mc ON m.category_id = mc.category_id
                JOIN trip_member tm ON p.trip_id = tm.trip_id
                LEFT JOIN payment_participant pp ON p.payment_id = pp.payment_id
        WHERE p.trip_id = #{tripId}
          AND tm.user_id = #{userId}
        ORDER BY p.pay_at desc;
    </select>

    <!-- paymentId로 단일 결제 내역 불러오기: 사용자 검증 포함 -->
    <select id="selectPaymentById"
            parameterType="int"
            resultMap="PaymentListResultMap">
        SELECT
            p.payment_id AS paymentId,
            m.merchant_id AS merchantId,
            m.merchant_name AS merchantName,
            mc.category_id AS categoryId,
            mc.category_name AS categoryName,
            u.user_id AS userId,
            u.nickname AS nickname,
            p.pay_at AS payAt,
            p.amount,
            p.payment_type AS paymentType,
            p.memo
        FROM payment p
                 JOIN users u ON p.user_id = u.user_id
                 JOIN merchant m ON p.merchant_id = m.merchant_id
                 JOIN merchant_category mc ON m.category_id = mc.category_id
                 JOIN trip_member tm ON p.trip_id = tm.trip_id
        WHERE p.payment_id = #{paymentId}
          AND tm.user_id = #{userId}
    </select>
</mapper>